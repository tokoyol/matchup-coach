name: Scheduled Matchup Refresh

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    env:
      REFRESH_PATCH: ${{ vars.REFRESH_PATCH || '26.3' }}
      REFRESH_MAX_PLAYERS: ${{ vars.REFRESH_MAX_PLAYERS || '80' }}
      REFRESH_MATCHES_PER_PLAYER: ${{ vars.REFRESH_MATCHES_PER_PLAYER || '20' }}
      REFRESH_MAX_UNIQUE_MATCHES: ${{ vars.REFRESH_MAX_UNIQUE_MATCHES || '2000' }}
      REFRESH_CONCURRENCY: ${{ vars.REFRESH_CONCURRENCY || '3' }}
    steps:
      - name: Check Riot key status
        id: riot_key
        env:
          BACKEND_BASE_URL: ${{ secrets.BACKEND_BASE_URL }}
        run: |
          if [ -z "$BACKEND_BASE_URL" ]; then
            echo "BACKEND_BASE_URL secret is required."
            exit 1
          fi
          STATUS_JSON=$(curl -fsS "$BACKEND_BASE_URL/api/admin/riot-key-status")
          echo "$STATUS_JSON"
          echo "status_json<<EOF" >> "$GITHUB_OUTPUT"
          echo "$STATUS_JSON" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          VALID=$(echo "$STATUS_JSON" | jq -r '.valid')
          EXPIRED=$(echo "$STATUS_JSON" | jq -r '.expired')
          echo "valid=$VALID" >> "$GITHUB_OUTPUT"
          echo "expired=$EXPIRED" >> "$GITHUB_OUTPUT"

      - name: Notify if Riot key expired
        if: steps.riot_key.outputs.expired == 'true'
        env:
          ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
          BACKEND_BASE_URL: ${{ secrets.BACKEND_BASE_URL }}
        run: |
          MSG="Riot API key appears expired. Refresh stopped. Check $BACKEND_BASE_URL/api/admin/riot-key-status"
          if [ -n "$ALERT_WEBHOOK_URL" ]; then
            curl -fsS -X POST "$ALERT_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"text\":\"$MSG\",\"content\":\"$MSG\"}" || true
          fi
          echo "$MSG"
          exit 1

      - name: Trigger precompute refresh
        if: steps.riot_key.outputs.valid == 'true'
        env:
          BACKEND_BASE_URL: ${{ secrets.BACKEND_BASE_URL }}
          ADMIN_API_TOKEN: ${{ secrets.ADMIN_API_TOKEN }}
        run: |
          BODY="{\"patch\":\"$REFRESH_PATCH\",\"lanes\":[\"top\",\"jungle\",\"mid\",\"adc\",\"support\"],\"maxTrackedPlayers\":$REFRESH_MAX_PLAYERS,\"matchesPerPlayer\":$REFRESH_MATCHES_PER_PLAYER,\"maxUniqueMatches\":$REFRESH_MAX_UNIQUE_MATCHES,\"concurrency\":$REFRESH_CONCURRENCY}"
          if [ -n "$ADMIN_API_TOKEN" ]; then
            curl -fsS -X POST "$BACKEND_BASE_URL/api/admin/precompute-cache" \
              -H "Content-Type: application/json" \
              -H "x-admin-token: $ADMIN_API_TOKEN" \
              -d "$BODY"
          else
            curl -fsS -X POST "$BACKEND_BASE_URL/api/admin/precompute-cache" \
              -H "Content-Type: application/json" \
              -d "$BODY"
          fi
